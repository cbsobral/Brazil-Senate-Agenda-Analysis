---
title: 'Brazilian Senate Speeches'
output: 
  html_document: 
    toc: yes
    theme: paper
    toc_float:
      collapsed: yes
    df_print: kable
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r message=FALSE, warning=FALSE}
library(dplyr)
library(ggrepel)
library(ggplot2)
library(tidyverse)
library(tidytext)
library(quanteda)
library(quanteda.textmodels)
library(stm)
library(austin)
```

# Introduction
<style> body {text-align: justify} </style>
With support of a Party coalition named “Brazil above everything, God above everyone” , Bolsonaro was elected, in 2018, president of Brazil for the 2019-2022 term. Having served as congress representative (“deputado federal”) for the State of Rio de Janeiro since 1991, Bolsonaro reached notoriety for his populist,  sexist, homophobic, anti-human rights and often anti-democratic  political views.

After 4 consecutive elections of a left party (“Labour Party”, i.e. “Partido do Trabalhadores” – PT) for the presidency of Brazil, and on the aftermath of a controversial conviction of its most prominent leader -- and front runner in the election polls --  on corruption charges, Bolsonaro benefited from a rise in anti-leftness sentiment and took the leadership of the poll of candidates with a manifesto that was filled with religious/Christian language and that was based on three pillars, that were directly opposed to the agenda of left/progressive groups:
	
1. Liberalization of economic policy: promising deregulation, privatization and extinction of sectors of the public service;
	
2. Public Security policy: a criminal reform package meant to harden convictions for crimes; exempt law enforcement officials of liability for any deaths they may cause in service; facilitate the private possession of firearms;
	
3. Conservative Moral agenda: opposition of sex education in schools; opposition to policies that aim at extending equality of rights for LGBT people; opposition to pregnancy termination, even in the limited circumstances allowed in Brazilian Law (rape; health risk for woman; anencephaly of fetus); reinforcement of gender stereotypical roles.    
	
	
For this project, we are interested in assessing if, and to what extent, these three axis that constitute Bolsonaro’s political agenda are also resonating in the Brazilian Senate.
	
Brazil’s Senate House is composed of 3 senators per State and the Federal District, totaling 81 senators. Each of their term in office last for 8 years,  but the election cycle happens every 4 years, alternating the elections for 2/3 and 1/3 of the house.  Theoretically speaking, the alternate election cycle should render the Senate house less sensitive to momentary waves that, if salient in a given moment, could heavily influence the course of a presidential election. 
	
In 2018, 2/3 of the Senate chairs were elected (54 senators), while the remaining 1/3 had still half the term in office to complete. 
	
In this project, we analyzed the corpus of Senators’ speeches from the years 2019-2020, focusing on issues associated with these salient dimensions of Bolsonaro’s political plan.
	
Finally, we assess the religious discourse as a separate trend. While the use of religion in political life seems to be at odds with the laicity of Brazilian Constitution, it resonates both with conservative views in Brazil and the general beliefs of the majority of the constituency. We are interested, therefore, in assessing if there is any significant difference in the use of religion by Senators across the RILE spectrum. 


# Data

```{r Data_corpus_DFM}
# Load senators data frame
load('data/sen_df.Rda')

# Load speeches data frame
load('data/speech_df.Rda')

# Main Corpus 
corp_sen <- corpus(speech_df, docid_field = 'CodigoPronunciamento', 
                   text_field = 'Pronunciamento')

# Main DFM
dfmat_sen <- dfm(corp_sen,
  tolower = TRUE,
  remove_punct = TRUE,
  remove = stopwords('portuguese'),
  remove_numbers = TRUE,
  remove_separators = TRUE,
  remove_symbols = TRUE,
  stem = FALSE,  
  groups = 'Partido')

dfmat_sen <- dfm_select(dfmat_sen, min_nchar = 2)
docnames(dfmat_sen) <- paste(dfmat_sen$Partido)
```


# Senate

## General Characteristics Senate

Considering the 26 States plus the Federal District each are entitled to three senates, we would expect the sen_df to have 81 senators, however, Roraima (RR) had one of its senators (Chico Rodrigues) suspended from his activities following an investigation on diversion of resources. For the purposes of this analysis, we will consider the Federal District a State.

The Senate api only displays current senators' speeches, which is why Roraima only have 2 senators and the corpus only comprises speeches from 80 senators.

In what concerns gender, although females are the majority of Brazilian population (97 males per 100 females), women represent only 1/8 of the composition of the Senate House. 18 States have only male Senators (including Roraima, with only 2 Senators); 8 States have 2 Male Senators and 1 Female Senator and 1 State has 2 Female Senators and 1 Male Senator (Mato Grosso do Sul - MS)

In terms of party distribution, 16 parties have at least one senator in the present term. MDB, PSD and PODEMOS are the parties with largest representation, holding 13, 12 and 10 senators, respectively. All of PSD Senators are male, while PSD and PODEMOS have 1 Female Senator each. 

Looking into distribution of gender per party, 9 of these parties have at least one Female Senator; but only 1 party (PP) has 2 Female Senators.



```{r Characteristics_Senate}

sen_df %>% 
  count(state) %>% 
  arrange(n)

sen_df %>% 
  count(gender) %>% 
  arrange(n)

sen_df %>% 
  group_by(state, gender) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  arrange(desc(n))
  
sen_df %>% 
  count(party_abbr) %>% 
  arrange(n)

sen_df %>% 
  group_by(party_abbr, gender) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  arrange(desc(n)) 
```

Considering these characteristics of the Senate House, let's see if the speech distribution follows the same pattern, i.e., let's check if Females' are responsible for 1/8 of the total speeches, how speeches are distributed among these 16 Parties, and among the 27 States.


```{r Gender_Senate, message=FALSE, warning=FALSE}

# parties precisa ponderar a frequência esperada pelo número de senadores de cada partido
#group by party criar nova coluna mutate soma do número de senadores do partido/80


sen_df %>% 
  group_by(party_abbr, gender) %>% 
  summarise(n = n()) %>% 
  ungroup() %>% 
  mutate(prop = (n / sum(n))*100) 


# Plot senators by gender
gender_sen <- sen_df %>% 
  group_by(party_abbr, gender) %>% 
  summarise(n = n()) %>%
  ggplot(aes(party_abbr, n)) +
  geom_col(aes(fill = gender)) +
  ylab('# Senators') +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90)) 

# Plot speeches by gender
gender_speech <- speech_df %>% 
  group_by(Partido, Gender) %>% 
  summarise(n = n()) %>%
  ggplot(aes(Partido, n)) +
  geom_col(aes(fill = Gender)) +
  ylab('# Speeches') +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90))

# Plot speeches by gender = Plot expected frequency on the back

gender_speech <- speech_df %>% 
  group_by(Gender) %>% 
  summarise(n = n()) %>%
  ggplot(aes(n, Gender)) +
  geom_col(aes(fill = Gender)) +
  ylab('# Speeches') +
  coord_flip() +
  theme_classic()
  
gridExtra::grid.arrange(gender_sen, gender_speech)

# expected frequency of speeches per gender -- based on the number of  senators
expected <-  sen_df %>% 
  group_by(gender) %>% 
  summarise(n = n()) %>% 
  mutate(prop = (n / sum(n))*100) %>% 
  rename(n_sen = n, prop_sen = prop, Gender = gender)

# observed frequency of speeches
observed <- speech_df  %>% 
  group_by(Gender) %>% 
  summarise(n = n()) %>% 
  mutate(prop = (n / sum(n))*100) %>% 
  rename(n_speech = n, prop_speech = prop)

merge(expected, observed, by = 'Gender') %>% 
  select(Gender, prop_sen, prop_speech) %>% 
  pivot_longer(!Gender, names_to = 'Proportion', values_to = 'Value') %>% 
  mutate(across(is.numeric, ~ round(., 2))) %>% 
  ggplot(aes(Value, Proportion, group = Gender, fill = Gender, label = Value)) +
  geom_col(position = "dodge") + 
  geom_label(position = position_dodge(0.9), show.legend = FALSE) +
  coord_flip() +
  theme_minimal()
```


### UF
```{r UF_Senate}

# h line intercept y media dos speaches

state_sen <- sen_df %>% 
  group_by(state) %>% 
  summarise(n = n()) %>%
  ggplot(aes(state, n)) +
  geom_col(fill = "#00BFC4") +
  ylab('# Senators') +
  theme_classic() 

# Plot speeches by state
state_speech <- speech_df %>% 
  group_by(UfParlamentarNaData) %>% 
  summarise(n = n()) %>%
  ggplot(aes(UfParlamentarNaData, n)) +
  geom_col(fill = "#F8766D") +
  ylab('# Speeches') +
  theme_classic() 

gridExtra::grid.arrange(state_sen, state_speech)

```


## Right/Left Positions from Speeches   

```{r RILE_speaches}
# Wordfish
wf <- textmodel_wordfish(dfmat_sen, dir = c(20, 11), sparse = TRUE)
textplot_scale1d(wf)

# Data frame with Wordsfish party positions
theta_sen_wf <- as.data.frame(wf$theta, wf$docs) %>% 
    rownames_to_column('party') %>%
    rename(theta_sen_wf = 'wf$theta')
```

### Senado X Media

Plot wordfish scores x perceived party position by media -- `cemf_2019`.

```{r RILE_media, message=FALSE, warning=FALSE}
load('data/cemf_2019.Rda') # party position per media outlet

cemf_2019 <-  cemf_2019 %>% 
  mutate(score = if_else(pos == 'centro', 0, if_else(pos == 'esquerda', -1, 1)))

media_pos <-  merge(theta_sen_wf, cemf_2019, by = 'party')


media_pos %>% 
  arrange(score) %>%    
  mutate(party = factor(party, levels = party)) %>% 
  ggplot(aes(x = theta_sen_wf, y = score, label = party, col = party)) + 
  geom_point() + 
  geom_label_repel(show.legend = FALSE) +
  geom_abline() +
  xlim(-2.5, 2) +
  ylim(-2.5, 2) +
  theme_minimal()


media_pos %>% 
  select(party, score, theta_sen_wf) %>% 
  pivot_longer(!party, names_to = 'theta', values_to = 'value') %>% 
  ggplot(aes(x = theta, y = value, group = party, col = party)) + 
  geom_point() + 
  geom_line(aes(linetype = party), size = 0.5) +
  theme_minimal()
```

### 2018's Presidential Manifestos

```{r Presidential_Campaign}
# Load data frame with presidential election manifestos
load('data/pres_df.Rda')
```


```{r RILE_SenatevPresidential}
# Main Corpus 
corp_pres <- corpus(pres_df, docid_field = 'party', 
                   text_field = 'text')

# Main DFM
dfmat_pres <- dfm(corp_pres,
  tolower = TRUE,
  remove_punct = TRUE,
  remove = stopwords('portuguese'),
  remove_numbers = TRUE,
  remove_separators = TRUE,
  remove_symbols = TRUE,
  stem = FALSE)
```


All parties have more extreme values in the presidential manifestos. PT and PDT are more to the left on presidential manifestos, while the remaining parties are more to the right. 

```{r Topic_Model_Manifestos}

# topic_pres <- stm(dfmat_pres, K = 4, seed = 12345)
# labelTopics(topic_pres)

```


```{r Topic_Model_Senate}
## erro no topic senado: Error in hpbcpp(optim.out$par, doc_ct = doc.ct, mu = mu, siginv = siginv, : chol(): decomposition failed

# topic_sen_stm <- asSTMCorpus(dfmat_sen)
# topic_sen <- stm(documents = topic_sen_stm$documents, vocab = topic_sen_stm$vocab,
#            K = 4, data = topic_sen_stm$data, seed = 12345)
# 
# labelTopics(topic_sen)

```




```{r message=FALSE, warning=FALSE}
# austin
# as wfm
# wfm_pres <- as.wfm(dfmat_pres, word.margin = 2)
# 
# # wordfish pres
# wfa_pres <- wordfish(wfm_pres, dir = c(4, 3)) # PSOL, PSL
# 
# # match sen features with pres
# dfmat_match <- dfm_match(dfmat_sen, featnames(dfmat_pres))
# 
# # convert to wfm
# wfm_match <- as.wfm(dfmat_match, word.margin = 2)
# 
# # predict values to senate speeches
# theta_sen_au <- as.data.frame(predict(wfa_pres, newdata = wfm_match)) %>%
#   rownames_to_column('party') %>%
#   rename(theta_sen_au = 'predict(wfa_pres, newdata = wfm_match)')

load('data/theta/theta_sen_au.Rda')

# # pres scores
# theta_pres_au <- as.data.frame(wfa_pres$theta, wfa_pres$docs) %>%
#   rownames_to_column('party') %>%
#   rename(theta_pres = 'wfa_pres$theta')
# 
# # merge dfs -- theta pres and sen
# theta_ps <- merge(theta_pres_au, theta_sen_au, by = 'party')

# Load data frame with out of sample prediction for senate speeches
load('data/theta/theta_ps.Rda')

# Compare pres x sen
theta_ps %>% 
  arrange(theta_pres) %>%    
  mutate(party = factor(party, levels = party)) %>% 
  ggplot(aes(x = theta_pres, y = theta_sen_au, label = party, col = party)) + 
  geom_point() + 
  geom_label_repel(show.legend = FALSE) +
  geom_abline() +
  xlim(-2.5, 2) +
  ylim(-2.5, 2) +
  theme_minimal()
```

Party positions derived from presidential manifestos (using `austin` prediction for out of sample documents) are more centered. Wordfish positions are more polarized. 

```{r}
# Compare sen wordfish x sen/pres austin
theta_sen <- merge(theta_sen_wf, theta_sen_au, by = 'party')


theta_sen %>% 
  arrange(theta_sen_wf) %>%    
  mutate(party = factor(party, levels = party)) %>% 
  ggplot(aes(x = theta_sen_wf, y = theta_sen_au, label = party, col = party)) + 
  geom_point() + 
  geom_label_repel(show.legend = FALSE) +
  geom_abline() +
  xlim(-4, 3) +
  ylim(-4, 4) +
  theme_minimal()


theta_sen %>% 
  pivot_longer(!party, names_to = 'theta', values_to = 'value') %>% 
  ggplot(aes(x = theta, y = value, group = party, col = party)) + 
  geom_point() + 
  geom_line(aes(linetype = party), size = 0.5) +
  theme_minimal()
```

# Themes -- Economy, Security, Gender & Family

## Dictionary 

```{r}
# Create Dictionary with themes of interest
theme.lexicon <- dictionary(list(economy = c('econom*', 'desempreg*', 'inflação', 'demanda', 'oferta', 'negócios', 'empreg*', 'preço*', 'banco', 'dinheiro', 'gastos', 'dívida', 'juro*', 'control*', 'custo*', 'produtividade', 'índice', 'renda', 'pib', 'produto', 'bruto', 'empreg*', 'trabalh*', 'privat*', 'auxílio', 'desigualdade', 'petróleo', 'petro', 'desigual*', 'custo*', 'capital', 'ações', 'participação', 'aposent*', 'nacionalizar', 'mercado'), genfam = c('famíl*', 'famil*', 'just*', 'mulher*', 'solteir*', 'sex*', 'pai*', 'mãe', 'filh*', 'abort*', 'criança*', 'abrigo', 'gênero', 'gay', 'kit gay', 'jove*', 'juventude', 'tradicional'), security = c('sequestr*', 'inocent*', 'puni*','condena*','sentença', 'tribunal', 'juiz', 'justiça', 'crim*', 'bandid*', 'criminos*', 'ilícit*', 'infrator*', 'impunidade', 'promotor*', 'instância', 'transitado', 'julgado', 'julgamento', 'bala', 'balead*', 'tiro', 'fuzil', 'arma', 'armamento', 'pistola', 'rifle', 'polícia', 'policial', 'militar', 'cidadão de bem', 'cadeia*', 'prisão', 'prisioneir*', 'investigação', 'intervenção militar', 'UPP', 'segurança pública', '*anticrime', '*anti-crime', 'assassin*', 'ladrão', 'vagabund*', 'saidão', 'condicional', 'progressão de regime', 'réu', 'defensoria', 'estupr*', 'traficante*', 'detenção', 'detent*',  'violência', 'reincidente', 'reincidência', 'delinquente', 'menor', 'maioridade penal', 'drogas', 'entorpecent*')))

# Create DFM with theme.lexicon, apply weights and convert to data frame
theme_df  <- dfm(corp_sen, dictionary = theme.lexicon) %>% 
    dfm_weight(scheme = 'prop') %>% 
    convert('data.frame')
```


## Analysis Econ

### Data Econ
```{r}
# List with documents about economy
econ_id <- theme_df %>% 
  filter(economy > genfam & economy > security) %>% 
  pull(doc_id)

# DFM with econ documents
dfmat_econ <- speech_df %>% 
  subset(CodigoPronunciamento %in% econ_id) %>% 
  corpus(docid_field = 'CodigoPronunciamento', text_field = 'Pronunciamento') %>% 
  dfm(tolower = TRUE,
      remove_punct = TRUE,
      remove = stopwords('portuguese'),
      remove_numbers = TRUE,
      remove_separators = TRUE,
      remove_symbols = TRUE,
      stem = FALSE,  
      groups = 'Partido')

dfmat_econ <- dfm_select(dfmat_econ, min_nchar = 2)
```

### Econ Scaling
```{r}
# Wordfish for econ
dfmat_econ[20, 1]
dfmat_econ[11, 1]

wf_econ <- textmodel_wordfish(dfmat_econ, dir = c(20, 11), sparse = TRUE)

textplot_scale1d(wf_econ)
```

 
```{r}
# Features usage left/right
feat_econ <- data.frame(
  word = wf_econ$features,
  beta = wf_econ$beta,
  psi = wf_econ$psi,
  stringsAsFactors = FALSE)

# Left
econ_l <- feat_econ %>% 
  top_n(200, psi) %>% 
  top_n(-10, beta)
  #DT::datatable()

# Right
econ_r <- feat_econ %>% 
  top_n(200, psi) %>% 
  top_n(10, beta) 
  #DT::datatable()

rbind(econ_l, econ_r) %>% 
  arrange(beta) %>%    
  mutate(word = factor(word, levels = word)) %>% 
  ggplot(aes(x = word, y = beta)) +
  geom_col() +
  coord_flip() +
  theme_classic()
```


```{r}
words_econ <- c('trabalho', 'petrobrás', 'auxílio', 'previdência', 'covid', 'desemprego',
               'emprego', 'amazônia')

scores_econ <- arrange(filter(feat_econ, word %in% words_econ),
                      beta)

ggplot(scores_econ, aes(beta, psi, label = word)) +
  geom_point(color = 'grey', alpha = 0.2) +
  geom_text_repel(data = scores_econ, col = 'black') +
  geom_point(data = scores_econ) +
  labs(x = 'Word Score', y = 'Word Frequency') +
  ggtitle('Estimated Word Positions for Selected Debate Vocabulary') +
  theme_minimal()
```

```{r}
# 'Fighting words'
zeta_wf <- wf_econ$beta*sqrt(exp(wf_econ$psi))
names(zeta_wf) <- colnames(dfmat_econ)
sort(zeta_wf,dec = T)[1:20]

# plot(wf_econ$psi,zeta_wf, col=rgb(0,0,0,.5), pch=19, cex=.5)
# text(wf_econ$psi,zeta_wf, names(zeta_wf), pos=4, cex=.6)
```


```{r}
# Find meaningful words by party
parties_pres <- unique(pres_df$party)

tidy(dfmat_econ) %>% 
  bind_tf_idf(term, document, count) %>% 
  filter(document %in% parties_pres) %>% 
  arrange(desc(tf_idf)) %>% 
  group_by(document) %>%
  slice_max(tf_idf, n = 15) %>%
  ungroup() %>%
  ggplot(aes(tf_idf, fct_reorder(term, tf_idf), fill = document)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ document, ncol = 3, scales = 'free') +
  labs(x = 'tf-idf', y = NULL)
```


## Analysis Security

## Security

```{r Security_analysis}
# List with documents about security
sec_id <- theme_df %>% 
  filter(security > genfam & security > economy) %>% 
  pull(doc_id)

# DFM with sec documents
dfmat_sec <- speech_df %>% 
  subset(CodigoPronunciamento %in% sec_id) %>% 
  corpus(docid_field = 'CodigoPronunciamento', text_field = 'Pronunciamento') %>% 
  dfm(tolower = TRUE,
      remove_punct = TRUE,
      remove = stopwords('portuguese'),
      remove_numbers = TRUE,
      remove_separators = TRUE,
      remove_symbols = TRUE,
      stem = FALSE,  
      groups = 'Partido')


# Wordfish for sec

dfmat_sec[19, 1]
dfmat_sec[11, 1]

wf_sec <- textmodel_wordfish(dfmat_sec, dir = c(19, 11), sparse = TRUE)

textplot_scale1d(wf_sec)
```
```{r}
# Features usage left/right
feat_sec <- data.frame(
  word = wf_sec$features,
  beta = wf_sec$beta,
  psi = wf_sec$psi,
  stringsAsFactors = FALSE)

# Left
sec_l <- feat_sec %>% 
  top_n(200, psi) %>% 
  top_n(-10, beta)
  #DT::datatable()

# Right
sec_r <- feat_sec %>% 
  top_n(200, psi) %>% 
  top_n(10, beta) 
  #DT::datatable()

rbind(sec_l, sec_r) %>% 
  arrange(beta) %>%    
  mutate(word = factor(word, levels = word)) %>% 
  ggplot(aes(x = word, y = beta)) +
  geom_col() +
  coord_flip() +
  theme_classic()
```

```{r}
#textplot_keyness(textstat_keyness(dfmat_sec, target = dfmat_sec$Partido == 'PT'))
```

```{r}
words_sec <- c('bandido', 'cadeia', 'prisão', 'vagabundo', 'arma', 'tiro',
               'policial')

scores_sec <- arrange(filter(feat_sec, word %in% words_sec),
                      beta)

ggplot(scores_sec, aes(beta, psi, label = word)) +
  geom_point(color = 'grey', alpha = 0.2) +
  geom_text_repel(data = scores_sec, col = 'black') +
  geom_point(data = scores_sec) +
  labs(x = 'Word Score', y = 'Word Frequency') +
  ggtitle('Estimated Word Positions for Selected Debate Vocabulary') +
  theme_minimal()
```

## Analysis Gender & Family

```{r}
# List with documents about gender and family 
genfam_id <- theme_df %>% 
  filter(genfam > security & genfam > economy) %>% 
  pull(doc_id)

# DFM with econ documents
dfmat_genfam <- speech_df %>% 
  subset(CodigoPronunciamento %in% genfam_id) %>% 
  corpus(docid_field = 'CodigoPronunciamento', text_field = 'Pronunciamento') %>% 
  dfm(tolower = TRUE,
      remove_punct = TRUE,
      remove = stopwords('portuguese'),
      remove_numbers = TRUE,
      remove_separators = TRUE,
      remove_symbols = TRUE,
      stem = FALSE,  
      groups = 'Partido')

dfmat_genfam <- dfm_trim(dfmat_genfam, min_termfreq = 2, min_docfreq = 2)

# Wordfish for econ
dfmat_genfam[19, 1]
dfmat_genfam[11, 1]

wf_genfam <- textmodel_wordfish(dfmat_genfam, dir = c(19, 11), sparse = TRUE)

textplot_scale1d(wf_genfam)
```

```{r}
# Features usage left/right
feat_genfam <- data.frame(
  word = wf_genfam$features,
  beta = wf_genfam$beta,
  psi = wf_genfam$psi,
  stringsAsFactors = FALSE)

# Left
genfam_l <- feat_genfam %>% 
  top_n(200, psi) %>% 
  top_n(-20, beta)
  #DT::datatable()

# Right
genfam_r <- feat_genfam %>% 
  top_n(200, psi) %>% 
  top_n(20, beta) 

rbind(genfam_l, genfam_r) %>% 
  arrange(beta) %>%    
  mutate(word = factor(word, levels = word)) %>% 
  ggplot(aes(x = word, y = beta)) +
  geom_col() +
  coord_flip() +
  theme_classic()
```

```{r}
#textplot_keyness(textstat_keyness(dfmat_genfam, target = dfmat_genfam$Partido == 'PT'))
```
