---
title: 'Brazilian Senate Speeches'
output: 
  html_document: 
    toc: yes
    theme: paper
    toc_float:
      collapsed: yes
    df_print: kable
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r message=FALSE, warning=FALSE}
library(dplyr)
library(ggrepel)
library(ggplot2)
library(tidyverse)
library(tidytext)
library(quanteda)
library(quanteda.textmodels)
library(stm)
```

# Intro Elections/Brazil/2018/Senate/Research Questions

# Data

Acho que vale explicar o que tem nas duas dfs. # carol

```{r}
# Load senators data frame
load('data/sen_df.Rda')

# Load speeches data frame
load('data/speech_df.Rda')

# Main Corpus 
corp_sen <- corpus(speech_df, docid_field = 'CodigoPronunciamento', 
                   text_field = 'Pronunciamento')

# Main DFM
dfmat_sen <- dfm(corp_sen,
  tolower = TRUE,
  remove_punct = TRUE,
  remove = stopwords('portuguese'),
  remove_numbers = TRUE,
  remove_separators = TRUE,
  remove_symbols = TRUE,
  stem = FALSE,  
  groups = 'Partido')

dfmat_sen <- dfm_select(dfmat_sen, min_nchar = 2)
docnames(dfmat_sen) <- paste(dfmat_sen$Partido)
```


# Senate

## General Characteristics Senate
Características do corpus (número de senadores, número de discursos por estado e gênero)
→ frequência esperada e frequência observada (Ana)
### Gender
### UF


## Right/Left Positions from Speeches   

```{r}
wf <- textmodel_wordfish(dfmat_sen, dir = c(20, 11), sparse = TRUE)
textplot_scale1d(wf)
```

### Senado X Media: Plot wordfish scores x perceived party position by media -- `wiki_partidos`. (Stefania)

```{r}
load('data/wiki_partidos.Rda') # party position per media outlet
```

### 2018 Presidential Candidates Manifestos

> os valores provavelmente precisam ser normalizados para efeitos de comparação. talvez usar wordscores e predict().

```{r}
# Load data frame with presidential election manifestos
load('data/pres_df.Rda')

# Corpus 
corp_pres <- corpus(pres_df, docid_field = 'id', 
                   text_field = 'text')

# Main DFM
dfmat_pres <- dfm(corp_pres,
  tolower = TRUE,
  remove_punct = TRUE,
  remove = stopwords('portuguese'),
  remove_numbers = TRUE,
  remove_separators = TRUE,
  remove_symbols = TRUE,
  stem = FALSE)

docnames(dfmat_pres) <- paste(dfmat_pres$name)
```

```{r}
wf_pres <- textmodel_wordfish(dfmat_pres, dir = c(4, 3), sparse = TRUE) # boulos, bolsonaro
#textplot_scale1d(wf_pres) # groups =  docvars(corp_pres, 'party'))

t_pres <- data.frame(
  party = dfmat_pres$party,
  theta_pres = wf_pres$theta, 
  stringsAsFactors = FALSE)

t_sen <- data.frame(
  party = dfmat_sen$Partido,
  theta_sen = wf$theta,
  stringsAsFactors = FALSE) 

t_comp <- merge(t_pres, t_sen, by = 'party')

# -- interpretação -- todos os partidos acima da linha de 45º estão mais a direita nos programas presidenciais x discursos do senado. PDT é a única exceção. Está mais à esquerda pres. 
t_comp %>% 
  arrange(theta_pres) %>%    
  mutate(party = factor(party, levels = party)) %>% 
  ggplot(aes(x = theta_sen, y = theta_pres, label = party, col = party)) + 
  geom_point() + 
  geom_label_repel(show.legend = FALSE) +
  geom_abline() +
  xlim(-2.5, 2.5) +
  ylim(-2.5, 2.5) +
  theme_minimal()
  
# -- interpretação -- como no gráfico anterior, todos os partidos ficam mais à direita no pres -- slope negativo. Exceção do PDT. 
t_comp %>% 
  pivot_longer(!party, names_to = 'theta', values_to = 'value') %>% 
  ggplot(aes(x = theta, y = value, group = party, col = party)) + 
  geom_point() + 
  geom_line(aes(linetype = party), size = 0.5) +
  theme_minimal()
```

# Themes -- Econ, Security, Stefania

## Dictionary 

```{r}
# Create Dictionary with themes of interest
theme.lexicon <- dictionary(list(economy = c('econom*', 'desempreg*', 'inflação', 'demanda', 'oferta', 'negócios', 'empreg*', 'preço*', 'banco', 'dinheiro', 'gastos', 'dívida', 'juro*', 'control*', 'custo*', 'produtividade', 'índice', 'renda', 'pib', 'produto', 'bruto', 'empreg*', 'trabalh*', 'privat*'), security = c('segurança'), stefania = c('mulher')))

# Create DFM with theme.lexicon, apply weights and convert to data frame
theme_df  <- dfm(corp_sen, dictionary = theme.lexicon) %>% 
    dfm_weight(scheme = 'prop') %>% 
    convert('data.frame')
```


## Analysis Econ

### Data Econ
```{r}
# List with documents about economy
econ_id <- theme_df %>% 
  filter(economy > 0.95) %>% 
  pull(doc_id)

# DFM with econ documents
dfmat_econ <- speech_df %>% 
  subset(CodigoPronunciamento %in% econ_id) %>% 
  corpus(docid_field = 'CodigoPronunciamento', text_field = 'Pronunciamento') %>% 
  dfm(tolower = TRUE,
      remove_punct = TRUE,
      remove = stopwords('portuguese'),
      remove_numbers = TRUE,
      remove_separators = TRUE,
      remove_symbols = TRUE,
      stem = FALSE,  
      groups = 'Partido')
```

### Econ Scaling
```{r}
# Wordfish for econ
dfmat_econ[20, 1]
dfmat_econ[11, 1]

wf_econ <- textmodel_wordfish(dfmat_econ, dir = c(20, 11), sparse = TRUE)

textplot_scale1d(wf_econ)
```

 
```{r}
# Features usage left/right
feat_econ <- data.frame(
  word = wf_econ$features,
  beta = wf_econ$beta,
  psi = wf_econ$psi,
  stringsAsFactors = FALSE)


# Graph top 30 psi per beta
feat_econ %>% 
  top_n(30, psi) %>%  # word fixed-effects == word frequency in all documents
  ggplot(aes(x = beta, y = psi, label = word)) +
  geom_point() +
  geom_text_repel() +
  theme_classic()

# Left
econ_l <- feat_econ %>% 
  top_n(200, psi) %>% 
  top_n(-10, beta)
  #DT::datatable()

# Right
econ_r <- feat_econ %>% 
  top_n(200, psi) %>% 
  top_n(10, beta) 
  #DT::datatable()

rbind(econ_l, econ_r) %>% 
  arrange(beta) %>%    
  mutate(word = factor(word, levels = word)) %>% 
  ggplot(aes(x = word, y = beta)) +
  geom_col() +
  coord_flip() +
  theme_classic()

# Graph word positions
#textplot_scale1d(wf_econ, margin = 'features', highlighted = 'petrobrás')
```

## Analysis Security

## Analysis Stefania's theme

## Bonus: Religion