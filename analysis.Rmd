---
title: 'Brazilian Senate Speeches'
output: 
  html_document: 
    toc: yes
    theme: paper
    toc_float:
      collapsed: yes
    df_print: kable
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r message=FALSE, warning=FALSE}
library(dplyr)
library(ggrepel)
library(ggplot2)
library(tidyverse)
library(tidytext)
library(quanteda)
library(quanteda.textmodels)
library(stm)
library(austin)
```

# Intro 
Elections/Brazil/2018/Senate/Research Questions

# Data

Acho que vale explicar o que tem nas duas dfs. # carol

```{r}
# Load senators data frame
load('data/sen_df.Rda')

# Load speeches data frame
load('data/speech_df.Rda')

# Main Corpus 
corp_sen <- corpus(speech_df, docid_field = 'CodigoPronunciamento', 
                   text_field = 'Pronunciamento')

# Main DFM
dfmat_sen <- dfm(corp_sen,
  tolower = TRUE,
  remove_punct = TRUE,
  remove = stopwords('portuguese'),
  remove_numbers = TRUE,
  remove_separators = TRUE,
  remove_symbols = TRUE,
  stem = FALSE,  
  groups = 'Partido')

dfmat_sen <- dfm_select(dfmat_sen, min_nchar = 2)
docnames(dfmat_sen) <- paste(dfmat_sen$Partido)
```


# Senate

## General Characteristics Senate
Características do corpus (número de senadores, número de discursos por estado e gênero)
→ frequência esperada e frequência observada (Ana)

### Gender

### UF


## Right/Left Positions from Speeches   

```{r}
wf <- textmodel_wordfish(dfmat_sen, dir = c(20, 11), sparse = TRUE)
textplot_scale1d(wf)

theta_sen_wf <- as.data.frame(wf$theta, wf$docs) %>% 
    rownames_to_column('party') %>%
    rename(theta_sen_wf = 'wf$theta')
```

### Senado X Media
Plot wordfish scores x perceived party position by media -- `wiki_partidos`. (Stefania)

```{r}
load('data/wiki_partidos.Rda') # party position per media outlet
```

### 2018 Presidential Manifestos

```{r}
# Load data frame with presidential election manifestos
load('data/pres_df.Rda')
```

```{r}
# list with unique parties from senate speeches
parties_sen <- unique(speech_df$Partido)

# create dfmat pres subset only with parties in senate
dfmat_pres_sub <- pres_df %>% 
  subset(party %in% parties_sen) %>%  
  corpus(docid_field = 'party', 
          text_field = 'text') %>% 
  dfm(tolower = TRUE,
      remove_punct = TRUE,
      remove = stopwords('portuguese'),
      remove_numbers = TRUE,
      remove_separators = TRUE,
      remove_symbols = TRUE,
      stem = FALSE)
```

All parties have more extreme values in the presidential manifestos. PT and PDT are more to the left on presidential manifestos, while the remaining parties are more to the right. 

```{r message=FALSE, warning=FALSE}
# # austin
# # as wfm
# wfm_pres <- as.wfm(dfmat_pres_sub, word.margin = 2)
# 
# # wordfish pres
# wfa_pres <- wordfish(wfm_pres, dir = c(6, 2))
# 
# # match sen features with pres
# dfmat_match <- dfm_match(dfmat_sen, featnames(dfmat_pres_sub))
# 
# # convert to wfm
# wfm_match <- as.wfm(dfmat_match, word.margin = 2)
# 
# # predict values to senate speeches
# theta_sen_au <- as.data.frame(predict(wfa_pres, newdata = wfm_match)) %>%
#   rownames_to_column('party') %>%
#   rename(theta_sen_au = "predict(wfa_pres, newdata = wfm_match)")

load('data/theta/theta_sen_au.Rda')

# # pres scores
# theta_pres_au <- as.data.frame(wfa_pres$theta, wfa_pres$docs) %>%
#   rownames_to_column('party') %>%
#   rename(theta_pres = 'wfa_pres$theta')
# 
# # merge dfs -- theta pres and sen
# theta_ps <- merge(theta_pres_au, theta_sen_au, by = 'party')

# Load data frame with out of sample prediction for senate speeches
load('data/theta/theta_ps.Rda')

# Compare pres x sen
theta_ps %>% 
  arrange(theta_pres) %>%    
  mutate(party = factor(party, levels = party)) %>% 
  ggplot(aes(x = theta_pres, y = theta_sen_au, label = party, col = party)) + 
  geom_point() + 
  geom_label_repel(show.legend = FALSE) +
  geom_abline() +
  xlim(-2.5, 2) +
  ylim(-2.5, 2) +
  theme_minimal()
```

Party positions derived from presidential manifestos (using `austin` prediction for out of sample documents) are more centered. Wordfish positions are more polarized. 

```{r}
# Compare sen wordfish x sen/pres austin
theta_sen <- merge(theta_sen_wf, theta_sen_au, by = 'party')


theta_sen %>% 
  arrange(theta_sen_wf) %>%    
  mutate(party = factor(party, levels = party)) %>% 
  ggplot(aes(x = theta_sen_wf, y = theta_sen_au, label = party, col = party)) + 
  geom_point() + 
  geom_label_repel(show.legend = FALSE) +
  geom_abline() +
  xlim(-4, 3) +
  ylim(-4, 4) +
  theme_minimal()


theta_sen %>% 
  pivot_longer(!party, names_to = 'theta', values_to = 'value') %>% 
  ggplot(aes(x = theta, y = value, group = party, col = party)) + 
  geom_point() + 
  geom_line(aes(linetype = party), size = 0.5) +
  theme_minimal()
```

# Themes -- Econ, Security, Stefania

## Dictionary 

```{r}
# Create Dictionary with themes of interest
theme.lexicon <- dictionary(list(economy = c('econom*', 'desempreg*', 'inflação', 'demanda', 'oferta', 'negócios', 'empreg*', 'preço*', 'banco', 'dinheiro', 'gastos', 'dívida', 'juro*', 'control*', 'custo*', 'produtividade', 'índice', 'renda', 'pib', 'produto', 'bruto', 'empreg*', 'trabalh*', 'privat*', 'auxílio', 'desigualdade', 'petróleo', 'petro', 'desigual*', 'custo*', 'capital', 'ações', 'participação', 'aposent*', 'nacionalizar', 'mercado'), security = c('segurança'), stefania = c('mulher')))

# Create DFM with theme.lexicon, apply weights and convert to data frame
theme_df  <- dfm(corp_sen, dictionary = theme.lexicon) %>% 
    dfm_weight(scheme = 'prop') %>% 
    convert('data.frame')
```


## Analysis Econ

### Data Econ
```{r}
# List with documents about economy
econ_id <- theme_df %>% 
  filter(economy > 0.97) %>% 
  pull(doc_id)

# DFM with econ documents
dfmat_econ <- speech_df %>% 
  subset(CodigoPronunciamento %in% econ_id) %>% 
  corpus(docid_field = 'CodigoPronunciamento', text_field = 'Pronunciamento') %>% 
  dfm(tolower = TRUE,
      remove_punct = TRUE,
      remove = stopwords('portuguese'),
      remove_numbers = TRUE,
      remove_separators = TRUE,
      remove_symbols = TRUE,
      stem = FALSE,  
      groups = 'Partido')

dfmat_econ <- dfm_select(dfmat_econ, min_nchar = 2)
```

### Econ Scaling
```{r}
# Wordfish for econ
dfmat_econ[20, 1]
dfmat_econ[11, 1]

wf_econ <- textmodel_wordfish(dfmat_econ, dir = c(20, 11), sparse = TRUE)

textplot_scale1d(wf_econ)
```

 
```{r}
# Features usage left/right
feat_econ <- data.frame(
  word = wf_econ$features,
  beta = wf_econ$beta,
  psi = wf_econ$psi,
  stringsAsFactors = FALSE)


# Graph top 30 psi per beta
feat_econ %>% 
  top_n(30, psi) %>%  # word fixed-effects == word frequency in all documents
  ggplot(aes(x = beta, y = psi, label = word)) +
  geom_point() +
  geom_text_repel() +
  theme_classic()

# Left
econ_l <- feat_econ %>% 
  top_n(200, psi) %>% 
  top_n(-10, beta)
  #DT::datatable()

# Right
econ_r <- feat_econ %>% 
  top_n(200, psi) %>% 
  top_n(10, beta) 
  #DT::datatable()

rbind(econ_l, econ_r) %>% 
  arrange(beta) %>%    
  mutate(word = factor(word, levels = word)) %>% 
  ggplot(aes(x = word, y = beta)) +
  geom_col() +
  coord_flip() +
  theme_classic()

# Graph word positions
#textplot_scale1d(wf_econ, margin = 'features', highlighted = 'petrobrás')
```


```{r}
testwords <- c("trabalho", "petrobrás", "auxílio", "previdência", "covid", "desemprego",
               "emprego")

testscores <- arrange(filter(feat_econ, word %in% testwords),
                      beta)

ggplot(testscores, aes(beta, psi, label = word)) +
  geom_point(color = "grey", alpha = 0.2) +
  geom_text_repel(data = testscores, col = "black") +
  geom_point(data = testscores) +
  labs(x = "Word score", y = "Offset parameter") +
  ggtitle("Estimated Word Positions for Selected Debate Vocabulary",
          subtitle = "Note: Offset parameter is roughly proportional to word frequency") +
  theme_minimal()
```

```{r}
# 'Fighting words'
zeta_wf <- wf_econ$beta*sqrt(exp(wf_econ$psi))
names(zeta_wf) <- colnames(dfmat_econ)
sort(zeta_wf,dec = T)[1:100]


# plot(wf_econ$psi,zeta_wf, col=rgb(0,0,0,.5), pch=19, cex=.5)
# text(wf_econ$psi,zeta_wf, names(zeta_wf), pos=4, cex=.6)
```



```{r}
# Find meaningful words by party
tidy(dfmat_econ) %>% 
  bind_tf_idf(term, document, count) %>% 
  filter(document %in% parties_pres) %>% 
  arrange(desc(tf_idf)) %>% 
  group_by(document) %>%
  slice_max(tf_idf, n = 15) %>%
  ungroup() %>%
  ggplot(aes(tf_idf, fct_reorder(term, tf_idf), fill = document)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ document, ncol = 3, scales = "free") +
  labs(x = "tf-idf", y = NULL)
```


## Analysis Security

## Analysis Stefania's theme

## Bonus: Religion
